# Mamba2

### å‰ç½®çŸ¥è¯†:
#### çŸ©é˜µä¸­ç‰¹å¾å€¼çš„ä½œç”¨å’Œç‰¹å¾å‘é‡çš„ä½œç”¨
* ç‰¹å¾å€¼çš„ä½œç”¨: ç‰¹å¾å€¼æè¿°äº†ä¸€ä¸ªçŸ©é˜µï¼ˆæˆ–çº¿æ€§å˜æ¢ï¼‰åœ¨æŸäº›ç‰¹æ®Šæ–¹å‘ä¸Šçš„ç¼©æ”¾å› å­ï¼Œå®ƒæ­ç¤ºäº†çŸ©é˜µçš„é‡è¦ç‰¹æ€§ã€‚
* ç‰¹å¾å‘é‡æè¿°äº†çŸ©é˜µï¼ˆæˆ–çº¿æ€§å˜æ¢ï¼‰åœ¨ç‰¹å®šæ–¹å‘ä¸Šçš„ä¸å˜æ€§æ–¹å‘ï¼Œæ˜¯çº¿æ€§å˜æ¢ä¸­è¢«ä¿æŒå½¢çŠ¶çš„â€œç‰¹å®šæ–¹å‘â€ã€‚

![](https://image.chiullian.cn/img/202412051411385.png)
åœ¨ Mamba1 ä¸­ï¼Œå¦‚æœ A æ˜¯å¯¹è§’é˜µï¼Œå¹¶ä¸”åº”ç”¨ç›®æ ‡ä»…æ¶‰åŠå¿«é€Ÿåˆ†è§£å’Œè®¡ç®—ï¼Œåˆ™å¯ä»¥å¿½ç•¥ç‰¹å¾å‘é‡ï¼Œä»…ä¿ç•™ç‰¹å¾å€¼å¯¹è§’çŸ©é˜µã€‚ 
ä½†å¦‚æœåç»­æ­¥éª¤éœ€è¦ç”¨ç‰¹å¾å‘é‡æè¿°æ–¹å‘æ€§æˆ–æ¨¡å¼ï¼Œåˆ™ä»éœ€ä¿ç•™ã€‚è‹¥æ‚¨å¯¹å…·ä½“éƒ¨åˆ†æœ‰ç–‘é—®ï¼Œå¯ä»¥æä¾›æ›´å¤šç»†èŠ‚ä»¥ç¡®è®¤ã€‚

è¿™é‡Œç»ˆäºè¯´é€šäº†:
Mamba2 ä¸ºäº†ä½¿ç”¨çŸ©é˜µè¿ç®—å¹¶åŠ é€Ÿ, è¿›ä¸€æ­¥çš„ç®€å•åŒ– AçŸ©é˜µ, ä»åŸæ¥çš„å¯¹è§’é˜µ(Mamba1)çº¦æŸä¸Šå†å¢åŠ äº†çº¦æŸ,å¯¹è§’çº¿çš„å€¼ä¸€æ ·,è¿™æ ·å°±å˜æˆäº†`A = I*a` aæ˜¯ä¸€ä¸ªæ ‡é‡

#### åšå®¢è¿˜è§£é‡Šäº†,ä¸ºä½•å•ç‹¬çš„æ ‡é‡ä¸ä¼šæœ‰æŸå®³å‘¢:

> * é¦–å…ˆ Mamba1 çš„æ¯ä¸ªå¤´ä¹Ÿå¯ä»¥ç†è§£ä¸ºæ¯ä¸ªé€šé“, è€ŒMamba1çš„Aæ˜¯å¯¹è§’çŸ©é˜µ, æ‰€ä»¥ç›¸å½“äº,æ¯ä¸ªå€¼æ§åˆ¶ä¸€ä¸ªé€šé“ (***å³æ‰€æœ‰é€šé“å®Œå…¨ç”±ç‹¬ç«‹çš„ SSMs ç‹¬ç«‹æ§åˆ¶***)
> * ç„¶è€Œ Mamba2 ä¸­çš„ æ˜¯æ‰€æœ‰é€šé“å…±äº«ä¸€ä¸ªæƒé‡, è¿™æ ·å°±å¯ä»¥åŠ å¤§çŠ¶æ€ç»´åº¦ N

 -[x] å…·ä½“æ˜¯ä¼šä¸ä¼šæŸåä¿¡æ¯, ä½œè€…è¯´è¿˜ä¸èƒ½è¯æ˜,ä½†æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç ”ç©¶æ–¹å‘

#### åšå®¢ä¸ºæ­¤ä¸¾äº†ä¸€ä¸ªå¾ˆå½¢è±¡çš„ä¾‹å­:
åœ¨Mambaä¸­å¼•å…¥é€‰æ‹©æ€§ï¼ˆä¾‹å¦‚ï¼ŒAå–å†³äºè¾“å…¥Xï¼‰çš„ä¸»è¦åŸå› ä¹‹ä¸€æ˜¯è®©SSMèƒ½å¤Ÿæ§åˆ¶æ˜¯å¦è®°ä½æˆ–å¿½ç•¥ç‰¹å®šçš„ä¿¡æ¯ç‰‡æ®µ;
ä¾‹å¦‚ï¼Œå¦‚æœåœ¨æ–‡æœ¬è½¬å½•ä¸­é‡åˆ°å¡«å……ç¬¦â€œumâ€ã€‚ä½†æ˜¯å¦‚æœè¿™äº›ä¿¡æ¯åº”è¯¥è¢«å¿½ç•¥ï¼Œé‚£ä¹ˆæ•´ä¸ªçŠ¶æ€å¯ä»¥ä¸€èµ·å¿½ç•¥å®ƒï¼Œ
æ‰€ä»¥å¦‚æœçŠ¶æ€çš„åŠ¨æ€åœ¨æ‰€æœ‰ç‰¹å¾ä¹‹é—´å…±äº«ï¼Œåº”è¯¥æ˜¯å¯ä»¥çš„ã€‚

#### å¦‚ä½•è§£å†³çš„æ³¨æ„åŠ›çš„N^2çš„é—®é¢˜å‘¢.

L çŸ©é˜µå®šä¹‰å¦‚ä¸‹:

![](https://image.chiullian.cn/img/202412051525641.png)

M çš„çŸ©é˜µå®šä¹‰å¦‚ä¸‹:
![](https://image.chiullian.cn/img/202412051527211.png)

å…¶å® M å°±ç›¸å½“äºæ³¨æ„åŠ›æœºåˆ¶äº† C å·¦æ‹‰å‡ºæ¥, Bå³æ‹‰å‡ºæ¥, Aåˆæ˜¯ä¸€ä¸ªæ ‡é‡*å•ä½çŸ©é˜µ, å°±å˜æˆäº†L:
![](https://image.chiullian.cn/img/202412051526800.png)
å…¶å¯ä»¥è¢«è§£é‡Šä¸º`åŸºäºä½ç½®iå’Œjç›¸è·å¤šè¿œçš„â€œæŠ˜æ‰£å› å­â€`ã€‚
(This Tobias Katschçš„GateLoopè®ºæ–‡åŒæ—¶æ”¯æŒè¿™ç§è§£é‡Šã€‚åœ¨å®ƒçš„æ³¨æ„åŠ›å½¢å¼ä¸­ï¼Œè¿™ä¸ªä¾èµ–äºè¾“å…¥çš„ä½ç½®æ©ç å¯ä»¥è¢«è§£é‡Šä¸ºç¼–ç æ›¼å·´çš„â€œé€‰æ‹©æ€§â€çš„å…³é”®å› ç´ ï¼



å…·ä½“è§£é‡Šå¦‚ä¸‹:

![](https://image.chiullian.cn/img/202412051511386.png)

> ç®€å•æ¥è¯´å°±æ˜¯:å•ä¸ª SSM å¤´çš„æ€»çŠ¶æ€å¤§å°ä¸ºï¼Œåœ¨ Mamba1 ä¸­æ¯ä¸ªéƒ½ç”±å•ç‹¬çš„æ ‡é‡é€’å½’æ§åˆ¶ï¼Œä½†åœ¨ Mamba2 ä¸­ç”±å•ä¸ªå…±äº«é€’å½’æ§åˆ¶ã€‚

è§‰å¾—4å›ç­”çš„å¾ˆæœ‰è¯´æœåŠ›

> ç„¶åå°±æ˜¯ç”¨ä¸€äº›è¯æ˜æ‰‹æ³•è¯æ˜äº†æ³¨æ„åŠ›å°±æ˜¯ç‰¹æ®Šçš„çŠ¶æ€å¯¹å¶æ¨¡å‹

```
ç‰¹å®šåº”ç”¨çš„åˆç†æ€§
åœ¨æŸäº›ç‰¹å®šçš„ç¥ç»ç½‘ç»œæ¶æ„ä¸­ï¼ˆä¾‹å¦‚ Mamba-2 çš„ SSD å±‚ï¼‰ï¼Œè¿™æ ·ç®€åŒ–çš„çŸ©é˜µ A æˆ–è®¸è¶³ä»¥æ»¡è¶³ä»»åŠ¡éœ€æ±‚ã€‚
ç‰¹åˆ«æ˜¯ï¼Œå¦‚æœç½‘ç»œçš„å…¶ä»–éƒ¨åˆ†å·²ç»æ‰¿æ‹…äº†å¤§éƒ¨åˆ†çš„å¤æ‚éçº¿æ€§å˜æ¢
é‚£ä¹ˆ A çš„ä¸»è¦ä½œç”¨å¯èƒ½ä»…ä»…æ˜¯æä¾›ä¸€ä¸ªå…¨å±€çš„ç¼©æ”¾å› å­ã€‚
```
![](https://image.chiullian.cn/img/202412051420759.png)


![](https://image.chiullian.cn/img/202412051426207.png)
ä¸Šå›¾çš„ç¬¬ä¸€ä¸ªè¡¨ç¤ºçš„æ˜¯SSM4,ç¬¬äºŒä¸ªæ˜¯Mamba1é‡Œçš„, è€Œç¬¬ä¸‰ä¸ªåªæœ‰æ ‡é‡çš„è¡¨ç¤ºSSM6

> Mamba2çš„ä¸»è¦ç›®çš„æ˜¯ä½¿ç”¨çŸ©é˜µä¹˜æ³•,å……åˆ†åˆ©ç”¨GPU

#### SSM çŸ©é˜µçš„å·§å¦™è®¾è®¡

> è®ºæ–‡ä¸»è¦å¼ºè°ƒçš„å¯¹å¶å…³ç³», 
> SSM æ¨¡å‹ä¸»è¦å¼ºè°ƒçš„æ˜¯é¡ºåºå’Œé€»è¾‘, è€Œ Transformerå¼ºè°ƒçš„æ˜¯å…³ç³»å’Œå…³è”, æ–‡ç« å°±æ˜¯å¼ºè°ƒä»–ä¿©çš„å…³ç³»çš„å¯¹å¶, ç„¶åæ˜¯ä»–ä¿©æœ‰æ•ˆçš„ç»“åˆ,è¾¾æˆå®Œç¾çš„æ•ˆæœ

> å°½ç®¡ Mamba ä½¿ç”¨çš„æ˜¯å¹¶è¡Œçš„, ä½†æ˜¯è¿˜æ˜¯éœ€è¦ç‰¹æ®Šçš„ç¡¬ä»¶è®¾å¤‡æ‰èƒ½åŠ é€Ÿ, å³ä¾¿å¦‚æ­¤æ•ˆç‡è¿˜æ˜¯ä¸å¦‚ç¡¬ä»¶å‹å¥½çš„æ¨¡å‹(å¦‚ CNN å’Œ Transformer)é«˜æ•ˆ
> å› ä¸ºå®ƒæ²¡æœ‰åˆ©ç”¨***çŸ©é˜µä¹˜æ³•***å•å…ƒï¼Œè€Œç°ä»£åŠ é€Ÿå™¨(å¦‚ GPU å’Œ TPU)æ­£æ˜¯ä¸ºæ­¤è€Œä¸“é—¨è®¾è®¡çš„

#### è¿™æ˜¯Mamba1çš„ æ­¥éª¤

![](https://image.chiullian.cn/img/202411282236051.png)


æ€»ä¹‹ï¼Œè™½ç„¶æ—¶é—´ä¸å˜SSM ä¸è¿ç»­ã€é€’å½’å’Œå·ç§¯åºåˆ—æ¨¡å‹å¯†åˆ‡ç›¸å…³ï¼Œä½†å®ƒä»¬ä¸æ³¨æ„åŠ›æœºåˆ¶æ²¡æœ‰ç›´æ¥å…³ç³»ã€‚æ‰€ä»¥mamba2æƒ³æ­ç¤ºé€‰æ‹©æ€§SSMå’Œæ³¨æ„åŠ›æœºåˆ¶ä¹‹é—´çš„æ›´æ·±å±‚æ¬¡å…³ç³»ï¼Œå¹¶åˆ©ç”¨è¿™ä¸€ç‚¹æ˜¾è‘—æé«˜SSMçš„è®­ç»ƒé€Ÿåº¦ï¼ŒåŒæ—¶å…è®¸æ›´å¤§çš„çŠ¶æ€è§„æ¨¡N

é‡è¦å®šä¹‰:
![](https://image.chiullian.cn/img/202411281510677.png)

#### Mamba1 çš„å¹¶è¡Œç¼ºé™·: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
> æ—¶é—´å¤æ‚åº¦ä¸º O(N / t), tä¸ºæ ¸çš„æ•°é‡

![](https://image.chiullian.cn/img/202411282240071.png)

æ›´åŠ è¯¦ç»†ç‚¹å°±æ˜¯:
> å› ä¸ºä»midä¸­é—´åˆ†å¼€(éå¸¸éå¸¸åƒ çº¿æ®µæ ‘çš„åˆå¹¶), å·¦å³æ˜¯ç‹¬ç«‹çš„. 
> 
> H3 = AH2 + BX3, æ­¤æ—¶ç®—å‡ºæ¥çš„ H2æ˜¯æœªçŸ¥çš„ä½†æ˜¯é™¤äº†æœªçŸ¥çš„, å‰©ä¸‹çš„éƒ½ç®—å‡ºæ¥äº†, H2ä¼šåœ¨å·¦å­æ ‘é‡Œç®—å®Œ, ç„¶ååˆå¹¶å°±æ˜¯æŠŠå€¼æ¥è¿‡æ¥ç®—
> ![](https://image.chiullian.cn/img/202411282304250.png)
![](https://image.chiullian.cn/img/202411282302378.png)

ç”¨æ¥ä¼˜åŒ–çš„å¹¶è¡Œæ‰«æçš„

> å½’æ ¹ç»“åº•æˆ‘ä»¬çš„æœ€ç»ˆç›®çš„è¿˜æ˜¯***å»ç®—ä¸€ä¸ª y = Mx çš„MçŸ©é˜µ***, è€ŒMamba1 å¹¶è¡Œæ˜¾ç„¶ä¸å¤Ÿ, æ‰€ä»¥Mambaå°±æ˜¯å¯¹ä»–åšäº†è¿›ä¸€æ­¥çš„ä¼˜åŒ–, æ”¹æˆä½¿ç”¨çŸ©é˜µæ“ä½œ

![](https://image.chiullian.cn/img/202411301640540.png)

#### å¼•å…¥åŠå¯åˆ†çŸ©é˜µ
> ç®€å•ä»‹ç»ä¸€ä¸‹`ç»“æ„åŒ–çŸ©é˜µ`, å…¶å®å°±æ˜¯ä¸ºäº†ç®€åŒ–çŸ©é˜µä¹˜æ³•, è®©çŸ©é˜µå¯ä»¥å‹ç¼©, ç”¨æ›´å°‘çš„å‚æ•°è¡¨ç¤ºä¸€ä¸ªçŸ©é˜µ, å¹¶ä¸”é€šè¿‡å¿«é€Ÿç®—æ³•(æœ€é‡è¦çš„æ˜¯çŸ©é˜µä¹˜æ³•)ï¼Œç›´æ¥æ“ä½œè¿™ç§å‹ç¼©è¡¨ç¤º


é¦–å…ˆï¼Œå…ˆæ¥çœ‹ä¸‹åŠå¯åˆ†çŸ©é˜µ(Semiseparable Matrices)çš„å®šä¹‰ã€Œç§°ä¹‹ä¸ºå®šä¹‰3.1ï¼Œåœ¨æœ‰çš„æ–‡çŒ®ä¸­ä¹Ÿè¢«ç§°ä¸º (N, 0)-åŠå¯åˆ†æ€§)ã€
ä¸€ä¸ªï¼ˆä¸‹ä¸‰è§’ï¼‰çŸ©é˜µ ğ‘€æ˜¯ N-åŠå¯åˆ†çš„ï¼Œå¦‚æœåŒ…å«åœ¨ä¸‹ä¸‰è§’éƒ¨åˆ†(å³å¯¹è§’çº¿æˆ–ä»¥ä¸‹)çš„æ¯ä¸ªå­çŸ©é˜µçš„ç§©â€”â€”Rankæœ€å¤šä¸º Nï¼Œåˆ™ç§° Nä¸ºåŠå¯åˆ†çŸ©é˜µçš„é˜¶æ•°æˆ–ç§©

> ç®€å•æ¥è®²åŠå¯åˆ†çŸ©é˜µå°±æ˜¯ M çŸ©é˜µ, åŠå¯åˆ†çŸ©é˜µ(ä¸€ä¸ªä¸‹ä¸‰è§’çŸ©é˜µ), è€Œä¸”æ¯ä¸ªæµ…ç´«è‰²çš„å°æ¡†é‡Œçš„ç§©å¾ˆå°
> ![](https://image.chiullian.cn/img/202412022240155.png)


## æœ€é‡è¦çš„ç‚¹ å…³äº Mamba2

æœ¬æ–‡æœ€é‡è¦çš„çŸ­å°±æ˜¯è®¾è®¡äº†ä¸€ä¸ªè¿™ä¸ªçŸ©é˜µ:
![](https://image.chiullian.cn/img/202412031409137.png)

å¤§å®¶ä¸è¦è¢«å¦‚ä¸‹çŸ©é˜µç»™è¯¯æ‰°äº†, è¿™ä¸ªå¼å­åªæ˜¯è¡¨æ˜äº† M çš„çŸ©é˜µè®¾è®¡å°±ç›¸å½“äº QK^T * V è€Œå®é™…çš„ è¡¨ç¤ºäº† M çŸ©é˜µé‡Œå°±æ˜¯æ³¨æ„åŠ›æœºåˆ¶:
![](https://image.chiullian.cn/img/202412031410401.png)

> åœ¨ç»å…¸çš„æ³¨æ„åŠ›æœºåˆ¶ä¸­ï¼ŒQKâŠ¤ æ˜¯æ ¸å¿ƒéƒ¨åˆ†ï¼Œç”¨äºè®¡ç®—æ‰€æœ‰æ—¶é—´æ­¥ä¹‹é—´çš„ç›¸ä¼¼æ€§ï¼Œå¤æ‚åº¦ä¸º O(n^2)ã€‚
> åœ¨ Mamba-2 ä¸­ï¼ŒQKâŠ¤ çš„æ˜¾å¼å½¢å¼ç¡®å® ***ä¸å­˜åœ¨***ï¼Œå®ƒçš„åŠŸèƒ½é€šè¿‡çŠ¶æ€ç©ºé—´æ¨¡å‹ä¸­ M çš„æ„é€ éšå¼å®ç°ã€‚

M çŸ©é˜µä¸­çš„æ¯ä¸€é¡¹![](https://image.chiullian.cn/img/202412031418859.png) å…¶å®å°±æ˜¯æ³¨æ„åŠ›:

> å…¶ä¸­æ¯ä¸ªå…ƒç´  Mij ç›´æ¥è¡¨ç¤ºä¸¤ä¸ªæ—¶é—´æ­¥ Xi,Xj ä¹‹é—´çš„éšå¼ç›¸ä¼¼æ€§ï¼ˆå³æ³¨æ„åŠ›æƒé‡ï¼‰ã€‚ è¿™æ„å‘³ç€ï¼šMij å°±æ˜¯æ³¨æ„åŠ›æƒé‡ï¼Œç”¨äºè¡¡é‡æ—¶é—´æ­¥ Xi å’Œ Xj çš„ç›¸äº’å½±å“ã€‚

### !!! Mambaä¸­ æ˜¯å¦‚ä½•è¿›è¡Œæ³¨æ„åŠ›çš„æ“ä½œçš„:
> Cj å’Œ Bi æ˜¯åˆ—å‘é‡, åˆ†åˆ«ä»£è¡¨è¡Œå’Œåˆ—çš„æƒé‡


![](https://image.chiullian.cn/img/202412031425213.png)


å¯¹æ¯”ä¼ ç»Ÿæ³¨æ„åŠ›çš„è¯¦ç»†çš„åŒºåˆ«å¯¹æ¯”:
![](https://image.chiullian.cn/img/202412031422605.png)

> æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„ç‚¹å°±æ˜¯ Hippo å³å‹ç¼©åçš„çŸ©é˜µå¯¹è§’çº¿æ˜¯å›ºå®šçš„(éƒ½æ˜¯ä¸€ä¸ªç›¸åŒçš„æ•°)


å½“ç§©ä¸º 1 çš„æ—¶å€™ä¸Šé¢çš„åŠå¯åˆ†çŸ©é˜µä¼šé€€åŒ–SSMçŸ©é˜µ

> å› æ­¤ï¼Œä¹Ÿå°†1-SSçŸ©é˜µçš„çŸ©é˜µä¹˜æ³•ç§°ä¸ºæ ‡é‡SSMé€’å½’æˆ–ç´¯ç§¯ä¹˜ç§¯å’Œ(ç´¯ç§¯ä¹˜ç§¯å’Œçš„å¹¿ä¹‰å½¢å¼)ä½œä¸ºé€’å½’çš„åŸºæœ¬å½¢å¼ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æœ¬æ¬¡mamba2ä¸»è¦ç®—æ³•çš„æ„å»ºæ¨¡å—
> ä¹Ÿä»ä¾§é¢è¯´æ˜ï¼Œè®¸å¤šåºåˆ—æ¨¡å‹çš„ç®—æ³•å¯ä»¥å½’ç»“ä¸ºç»“æ„åŒ–çŸ©é˜µä¹˜æ³•ç®—æ³•

#### å¾ˆæ˜¾ç„¶æˆ‘ä»¬çš„ç›®çš„æ˜¯æ›´å¿«çš„è®¡ç®—å‡º ä¸­é—´ä¸€å¯¹çŸ©é˜µçš„ä¹˜æ³• Aj...i
> å› ä¸º C çŸ©é˜µå’Œ BçŸ©é˜µéƒ½æ˜¯ä¸€ç»´çš„, å…ˆæŠŠä¸­é—´çš„ç®—å‡ºæ¥èƒ½åŠ é€Ÿè¿ç®—, æ‰€ä»¥çŸ©é˜µAçš„è®¾è®¡éå¸¸é‡è¦ä¹Ÿå°±æ˜¯ Hippo çŸ©é˜µ


![](https://image.chiullian.cn/img/202412041606753.png)

#### SSS, SSD, SS

![](https://image.chiullian.cn/img/202412041611963.png)

![](https://image.chiullian.cn/img/202412041833033.png)
